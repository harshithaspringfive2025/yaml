name: Build and Deploy Changed Mule Projects

on:
  push:
    branches:
      - main
    paths:
      - '**'
  workflow_dispatch:

jobs:
  get_changed_projects:
    runs-on: ubuntu-latest
    outputs:
      projects: ${{ steps.detect.outputs.projects }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Detect changed MuleSoft projects
        id: detect
        run: |
          echo "üîç Detecting changed MuleSoft projects..."

          BASE_SHA="${{ github.event.before }}"
          if [[ -z "$BASE_SHA" || "$BASE_SHA" == "0000000000000000000000000000000000000000" ]]; then
            BASE_SHA=$(git rev-list --max-parents=0 HEAD)
          fi
          HEAD_SHA="${{ github.sha }}"

          echo "Comparing commits: $BASE_SHA -> $HEAD_SHA"
          changed_dirs=$(git diff --name-only "$BASE_SHA" "$HEAD_SHA" | cut -d/ -f1 | sort -u)

          echo "Changed directories detected:"
          echo "$changed_dirs"

          valid_projects=()
          for dir in $changed_dirs; do
            if [[ -f "$dir/pom.xml" ]]; then
              echo "‚úÖ Including Mule project: $dir"
              valid_projects+=("\"$dir\"")
            fi
          done

          if [ ${#valid_projects[@]} -eq 0 ]; then
            echo "‚ö†Ô∏è No Mule projects changed. Skipping build."
            echo "projects=[]" >> $GITHUB_OUTPUT
          else
            json_output="[$(IFS=,; echo "${valid_projects[*]}")]"
            echo "projects=$json_output" >> $GITHUB_OUTPUT
          fi

  build_and_deploy:
    needs: get_changed_projects
    if: ${{ needs.get_changed_projects.outputs.projects != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: ${{ fromJson(needs.get_changed_projects.outputs.projects) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 11

      - name: Build Mule Project (Deployable + Studio Importable JAR) - ${{ matrix.project }}
        run: |
          cd "${{ matrix.project }}"
          echo "üî® Building project: ${{ matrix.project }}"
          echo "‚û°Ô∏è Generating both deployable JAR and Studio-importable JAR..."
          mvn clean package -DskipTests -DattachMuleSources
          echo "‚úÖ Build completed for ${{ matrix.project }}"

      - name: Debug target contents - ${{ matrix.project }}
        run: |
          echo "üìÇ Listing contents of target directory..."
          if [ ! -d "${{ matrix.project }}/target" ]; then
            echo "‚ùå No target directory found. Build failed."
            exit 1
          fi
          ls -la "${{ matrix.project }}/target"
          echo "üîç JAR files generated:"
          find "${{ matrix.project }}/target" -name "*.jar"

      - name: Deploy to CloudHub - ${{ matrix.project }}
        env:
          USERNAME: ${{ secrets.ANYPOINT_USERNAME }}
          PASSWORD: ${{ secrets.ANYPOINT_PASSWORD }}
          ENVIRONMENT: ${{ secrets.ANYPOINT_ENVIRONMENT }}
          REGION: ${{ secrets.ANYPOINT_REGION }}
        run: |
          cd "${{ matrix.project }}"
          artifact=$(ls target/*.jar 2>/dev/null | grep -v "original" | grep -v "studio" | head -1)

          if [[ -z "$artifact" ]]; then
            echo "‚ùå No deployable artifact found in target/"
            ls -la target/
            exit 1
          fi

          echo "üöÄ Deploying artifact to CloudHub: $artifact"
          mvn deploy -DmuleDeploy \
            -Danypoint.username="$USERNAME" \
            -Danypoint.password="$PASSWORD" \
            -Danypoint.environment="$ENVIRONMENT" \
            -Danypoint.region="$REGION" \
            -DskipTests -X

      - name: Upload Studio Importable JAR - ${{ matrix.project }}
        uses: actions/upload-artifact@v4
        with:
          name: studio-jar-${{ matrix.project }}
          path: |
            ${{ matrix.project }}/target/*-studio.jar
        continue-on-error: true
      - name: Echo Studio JAR Upload
        run: |
          echo "üì¶ Studio-importable JAR for ${{ matrix.project }} has been uploaded as a build artifact."‚Ä®‚Ä®
